<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>详细调试 EmulatorJS</title>
    <style>
        body { margin: 0; background: #000; color: #fff; font-family: Arial, sans-serif; }
        #emulator { width: 100vw; height: 60vh; background: #111; }
        .debug-panel { height: 40vh; background: #222; padding: 20px; overflow-y: auto; font-size: 12px; }
        .log { margin: 2px 0; padding: 2px 5px; border-radius: 3px; }
        .log.error { background: #ff4444; color: #fff; }
        .log.warn { background: #ffaa00; color: #000; }
        .log.info { background: #0088ff; color: #fff; }
        .log.success { background: #00ff44; color: #000; }
        .controls { position: absolute; top: 10px; right: 10px; z-index: 1000; }
        button { margin: 5px; padding: 8px 16px; border: none; border-radius: 4px; background: #4CAF50; color: white; cursor: pointer; }
        button:hover { background: #45a049; }
    </style>
</head>
<body>
    <div id="emulator"></div>
    
    <div class="controls">
        <button onclick="manualStart()">手动启动</button>
        <button onclick="clearLogs()">清空日志</button>
    </div>
    
    <div class="debug-panel">
        <h3>🔧 详细调试日志</h3>
        <div id="logs"></div>
    </div>

    <script>
        let logs = [];
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logs.push({timestamp, message, type});
            updateLogs();
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function updateLogs() {
            const logsEl = document.getElementById('logs');
            logsEl.innerHTML = logs.slice(-50).map(log => 
                `<div class="log ${log.type}">[${log.timestamp}] ${log.message}</div>`
            ).join('');
            logsEl.scrollTop = logsEl.scrollHeight;
        }
        
        function clearLogs() {
            logs = [];
            updateLogs();
        }
        
        function manualStart() {
            addLog('🔧 手动触发EmulatorJS启动', 'info');
            if (window.EJS_emulator && window.EJS_emulator.startButtonClicked) {
                window.EJS_emulator.startButtonClicked({});
                addLog('✅ 手动调用startButtonClicked', 'success');
            } else {
                addLog('❌ EJS_emulator或startButtonClicked不存在', 'error');
            }
        }
        
        // 设置EmulatorJS配置
        addLog('📝 设置EmulatorJS配置', 'info');
        window.EJS_player = '#emulator';
        window.EJS_gameUrl = '/roms/Contra1(U)30.nes';
        window.EJS_core = 'fceumm';  // 修正：使用EJS_core而不是EJS_system
        window.EJS_pathtodata = '/emulatorjs/';  // 修正：使用正确的路径
        window.EJS_gameName = '魂斗罗详细调试';
        window.EJS_startOnLoaded = true; // 尝试自动启动
        window.EJS_DEBUG_XX = true; // 启用调试模式
        window.EJS_disableDatabases = true; // 禁用数据库以加快加载
        
        addLog(`配置完成: core=${window.EJS_core}, startOnLoaded=${window.EJS_startOnLoaded}`, 'info');
        
        // 劫持console方法来捕获EmulatorJS的内部日志
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;
        
        console.log = function(...args) {
            const message = args.join(' ');
            if (message.includes('EmulatorJS') || message.includes('Loading') || message.includes('Download')) {
                addLog(`LOG: ${message}`, 'info');
            }
            originalLog.apply(console, args);
        };
        
        console.warn = function(...args) {
            const message = args.join(' ');
            addLog(`WARN: ${message}`, 'warn');
            originalWarn.apply(console, args);
        };
        
        console.error = function(...args) {
            const message = args.join(' ');
            addLog(`ERROR: ${message}`, 'error');
            originalError.apply(console, args);
        };
        
        // 监听全局错误
        window.addEventListener('error', (e) => {
            addLog(`全局错误: ${e.error?.message || e.message}`, 'error');
        });
        
        window.addEventListener('unhandledrejection', (e) => {
            addLog(`Promise错误: ${e.reason}`, 'error');
        });
        
        // 加载EmulatorJS
        addLog('📦 开始加载EmulatorJS...', 'info');
        
        const script = document.createElement('script');
        script.src = '/emulatorjs/loader.js';  // 修正：使用正确的路径
        
        script.onload = () => {
            addLog('✅ loader.js加载成功', 'success');
            
            // 监控EmulatorJS对象的创建
            let checkCount = 0;
            const checkEmulator = setInterval(() => {
                checkCount++;
                
                if (window.EJS_emulator) {
                    addLog('🎯 EJS_emulator对象已创建！', 'success');
                    
                    // 检查EmulatorJS的重要方法
                    const methods = ['startButtonClicked', 'downloadGameCore', 'getCore'];
                    methods.forEach(method => {
                        if (window.EJS_emulator[method]) {
                            addLog(`✅ 方法存在: ${method}`, 'success');
                        } else {
                            addLog(`❌ 方法缺失: ${method}`, 'error');
                        }
                    });
                    
                    // 检查核心检测
                    if (window.EJS_emulator.getCore) {
                        const core = window.EJS_emulator.getCore();
                        addLog(`🎮 检测到核心: ${core}`, 'info');
                    }
                    
                    // 尝试监听EmulatorJS事件
                    if (window.EJS_emulator.on) {
                        window.EJS_emulator.on('ready', () => {
                            addLog('🎮 EmulatorJS ready事件触发', 'success');
                        });
                        
                        window.EJS_emulator.on('start-clicked', () => {
                            addLog('🚀 start-clicked事件触发', 'success');
                        });
                        
                        window.EJS_emulator.on('start', () => {
                            addLog('🕹️ start事件触发 - 游戏开始！', 'success');
                        });
                        
                        addLog('📡 已注册EmulatorJS事件监听器', 'info');
                    }
                    
                    clearInterval(checkEmulator);
                    
                } else if (checkCount > 100) {
                    addLog('⏰ EmulatorJS初始化超时', 'error');
                    clearInterval(checkEmulator);
                } else if (checkCount % 10 === 0) {
                    addLog(`⏳ 等待EmulatorJS初始化... (${checkCount}/100)`, 'info');
                }
            }, 100);
        };
        
        script.onerror = () => {
            addLog('❌ loader.js加载失败！', 'error');
        };
        
        document.head.appendChild(script);
        
        // 页面加载完成
        window.addEventListener('load', () => {
            addLog('📄 页面加载完成', 'success');
        });
    </script>
</body>
</html> 